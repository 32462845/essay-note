# stomp-点对点-自由订阅

所谓点对点，具体的源码我没有去看过，在spring-websocket 3.4.5 以前的版本我无意中在网络上的各种资料中尝试了很多写法。只有一种让我成功了。

```java
前端订阅地址写：/topic/用户名/xxx
后端发送的时候也是:/topic/用户名/xxx
```
这样看来其实都是走的消息代理，只是这个订阅地址，只有被授权的人知道罢了。 大概的跟着了下源码。stomp的大致原理也是这样的。 

拦截user开头的前缀然后拼接用户名`/user/用户名/具体的订阅地址`,后端发送的时候，调用的api也是专用的，该api也会把地址拼接成拦截时候修改的那样。完成了一个转换。更具体的原理没有去深挖。


好了基本的了解之后。来实现点对点订阅

其实对于api来说不算什么难事。我反倒是对于怎么维护状态比较关心。

平时的http一个请求一个响应，是无状态的。现在使用同一个链接，不同地址路由到不同的方法中去，这个也是没有问题的，要实现后端主动推送变化的数据，你还得保存每个用户所订阅类别是什么。这就变成了有状态。那么总结出来有以下几个点需要解决：

1. 怎么保存用户的选择状态
2. 状态保存后，什么时机清空该状态？（用户断开了stomp链接、离开了该页面等）

## 前端实现

考虑一下该需求。这里是两个不同的新闻类型，可以看成是 查询条件。只要传递不同的条件则返回的数据不一样。

这里我把两个订阅的合并成一个来实现，是为了演示怎么使用发送消息来改变条件，和服务器交互。

前端怎么通过stomp发送条件到后端呢？

```javascript
```