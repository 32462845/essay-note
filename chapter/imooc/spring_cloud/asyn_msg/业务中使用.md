# 业务中使用

* 商品和订单服务中使用MQ
* 异步扣库存分析

## 商品和订单服务中使用MQ
省略。简单的业务逻辑

## 异步扣库存分析

原始流程

* 查询商品信息（调用商品服务）
* 计算总价（生成订单详情）
* 商品服务和扣库存 （调用商品服务）
* 订单入库（生成订单）

异步扣库存分析： 通过消息队列

1. 订单服务创建订单（状态为排队中），并发布消息，创建订单了，需要扣减库存
2. 商品服务扣减库存，并回复消息操作结果

要达到以上的流程，必须有一些依赖：

* 可靠的消息投递

对于异步消息来说，一定要针对业务来说，能不异步则不异步。因为会涉及到很多细节的修改；


## 异步扣库存逻辑如下

1. 库存在Redis中保存
2. 收到请求Redis判断是否库存充足，减掉Redis中库存
3. 订单服务创建订单写入数据库，并发送消息

当一方失败的时候，需要有机制进行补偿，或则手动回滚多方操作
